<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Input Judul dan Link ke Firebase</title>
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav>
      <a href="#" class="active" data-target="inputData">Masukkan Data</a>
      <a href="#" data-target="viewData">Lihat Data</a>
    </nav>

    <!-- Input Data Form -->
    <div id="inputData" class="content" style="display: block">
      <h1>Masukkan Judul dan Link</h1>
      <form id="dataForm">
        <label for="title">Judul: </label>
        <input type="text" id="title" required /><br /><br />
        <label for="link">Link Google Drive: </label>
        <input type="url" id="link" required /><br /><br />
        <button type="submit">Kirim Data</button>
      </form>
    </div>

    <!-- View Data Table -->
    <div id="viewData" class="content" style="display: none">
      <h2>Data yang Tersimpan</h2>
      <table border="1">
        <thead>
          <tr>
            <th>Judul</th>
            <th>Link</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Modal for Confirmation -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <p>Apakah Anda yakin ingin menghapus data ini?</p>
        <button id="cancelDelete" class="cancel">Batal</button>
        <button id="confirmDelete" class="confirm">Hapus</button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        remove,
        get,
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCCRYX_sccuZyS6U219jupC3iXuU81SvIk",
        authDomain: "hsnimageview.firebaseapp.com",
        databaseURL: "https://hsnimageview-default-rtdb.firebaseio.com/",
        projectId: "hsnimageview",
        storageBucket: "hsnimageview.appspot.com",
        messagingSenderId: "815454639020",
        appId: "1:815454639020:web:b29867dccb7d9c10676009",
        measurementId: "G-PK7Y8R7TWJ",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const form = document.getElementById("dataForm");
      const tableBody = document.getElementById("tableBody");
      const toast = document.getElementById("toast");
      const modal = document.getElementById("confirmModal");
      const confirmBtn = document.getElementById("confirmDelete");
      const cancelBtn = document.getElementById("cancelDelete");
      let deleteId = null;

      // Function to generate the Google Drive embed link
      function generateDriveEmbedLink(url) {
        const regex = /\/folders\/([a-zA-Z0-9_-]+)/;
        const match = url.match(regex);
        if (match && match[1]) {
          return `https://drive.google.com/embeddedfolderview?id=${match[1]}#grid`;
        }
        return url;
      }

      // Show toast notification
      function showToast(message) {
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // Delete data
      function deleteData(id) {
        deleteId = id;
        modal.style.display = "block";
      }

      confirmBtn.addEventListener("click", () => {
        if (deleteId) {
          remove(ref(database, "links/" + deleteId))
            .then(() => {
              document.getElementById(deleteId).remove();
              showToast("Data berhasil dihapus");
              modal.style.display = "none";
            })
            .catch((error) => {
              console.error("Error menghapus data:", error);
              showToast("Terjadi kesalahan saat menghapus data.");
            });
        }
      });

      cancelBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });

      // Load data from Firebase
      function loadData() {
        get(ref(database, "links")).then((snapshot) => {
          tableBody.innerHTML = "";
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.keys(data).forEach((id) => {
              const { title, link } = data[id];
              const embedLink = generateDriveEmbedLink(link);
              const row = document.createElement("tr");
              row.id = id;
              row.innerHTML = `
                            <td>${title}</td>
                            <td><a href="${embedLink}" target="_blank">${link}</a></td>
                            <td><button onclick="deleteData('${id}')">Hapus</button></td>
                        `;
              tableBody.appendChild(row);
            });
          }
        });
      }

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        const title = document.getElementById("title").value;
        const link = document.getElementById("link").value;

        // Jalankan fungsi generateDriveEmbedLink untuk mendapatkan link embed
        const embedLink = generateDriveEmbedLink(link);
        showToast("Data berhasil di simpan!");


        // Kirimkan data (judul dan link embed) ke Firebase
        push(ref(database, "links"), { title, link: embedLink }).then(() => {
          form.reset(); // Reset form setelah submit
          loadData(); // Reload data setelah submit
        });
      });

      // Handle navbar link switching
      const navLinks = document.querySelectorAll("nav a");
      const contentSections = document.querySelectorAll(".content");

      navLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
          navLinks.forEach((link) => link.classList.remove("active"));
          link.classList.add("active");

          const target = event.target.getAttribute("data-target");
          contentSections.forEach((section) => {
            section.style.display = section.id === target ? "block" : "none";
          });
        });
      });

      window.onload = loadData;
    </script>
  </body>
</html>
